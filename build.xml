<?xml version="1.0"?>
<project name="dbtune" default="compile">
  <taskdef resource="net/sf/antcontrib/antcontrib.properties">
    <classpath>
      <pathelement location="${lib.dir}/ant-contrib-1.0b3.jar"/>
    </classpath>
  </taskdef>
  <property file="build.properties"/>
  <path id="compile.classpath">
    <fileset dir="${lib.dir}" includes="*.jar"/>
    <fileset dir="extensions/" includes="**/*.jar"/>
  </path>

  <!-- core -->
  <target name="compile">
    <ant dir="." antfile="common.xml" target="compile">
      <property name="base.dir" value="${base.dir}" />
      <reference refid="compile.classpath" />
    </ant>
  </target>
  <target name="test.compile" depends="compile">
    <ant dir="." antfile="common.xml" target="test.compile">
      <property name="base.dir" value="${base.dir}" />
      <reference refid="compile.classpath" />
    </ant>
  </target>
  <target name="unit">
    <ant dir="." antfile="common.xml" target="unit">
      <property name="base.dir" value="${base.dir}" />
      <reference refid="compile.classpath" />
    </ant>
  </target>
  <target name="functional">
    <ant dir="." antfile="common.xml" target="functional">
      <property name="base.dir" value="${base.dir}" />
      <reference refid="compile.classpath" />
    </ant>
  </target>

  <!-- extensions -->
  <target name="compile.all" depends="compile">
    <foreach list="${extensions}" param="extension" target="compile.extension"/>
  </target>
  <target name="compile.extension">
    <ant dir="extensions/${extension}" antfile="build.xml" target="compile">
      <property name="base.dir" value="${base.dir}" />
      <property name="src.dir" value="${src.dir}" />
      <property name="build.dir" value="${build.dir}" />
      <property name="project" value="${extension}" />
    </ant>
  </target>
  <target name="test.compile.all" depends="compile.all,test.compile">
    <foreach list="${extensions}" param="extension" target="test.compile.extension"/>
  </target>
  <target name="test.compile.extension" depends="test.compile">
    <ant dir="extensions/${extension}" antfile="build.xml" target="test.compile">
      <property name="base.dir" value="${base.dir}" />
      <property name="src.dir" value="${src.dir}" />
      <property name="build.dir" value="${build.dir}" />
      <property name="project" value="${extension}" />
    </ant>
  </target>
  <target name="unit.all" depends="test.compile.all">
    <ant dir="." antfile="common.xml" target="unit">
      <property name="base.dir" value="${base.dir}" />
      <property name="build.dir" value="${build.dir}" />
      <reference refid="compile.classpath" />
    </ant>
  </target>
  <target name="functional.all" depends="test.compile.all">
    <ant dir="." antfile="common.xml" target="functional">
      <property name="base.dir" value="${base.dir}" />
      <property name="build.dir" value="${build.dir}" />
      <reference refid="compile.classpath" />
    </ant>
  </target>
  <target name="one" depends="test.compile.all">
    <ant dir="." antfile="common.xml" target="one">
      <property name="base.dir" value="${base.dir}" />
      <property name="build.dir" value="${build.dir}" />
      <reference refid="compile.classpath" />
    </ant>
  </target>
  <target name="test" depends="unit.all,functional.all"/>

  <!-- packaging -->
  <target name="jar">
    <ant dir="." antfile="common.xml" target="jar" />
  </target>
  <target name="javadoc">
    <ant dir="." antfile="common.xml" target="javadoc" />
  </target>
  <target name="jar.source">
    <ant dir="." antfile="common.xml" target="jar.source" />
  </target>
  <target name="clean">
    <ant dir="." antfile="common.xml" target="clean" />
  </target>

  <!--
  <target name="test.dist"
      depends="jar, test.compile-with-deps"
      description="Execute Unit tests against distribution jar.">
    <junit printsummary="yes"
         haltonerror="yes"
         haltonfailure="yes"
         fork="yes">

        <classpath>
            <pathelement location="${build.dir}/dbtune-${version}-tests.jar"/>
            <pathelement location="${build.dir}/dist/dbtune-${version}.jar"/>
            <pathelement location="lib/caliper-0.0.jar"/>
            <pathelement location="lib/junit-4.9b2.jar"/>
            <pathelement location="lib/mockito-all-1.8.5.jar"/>
            <pathelement location="lib/postgresql-9.0-801.jdbc4.jar"/>
            <pathelement location="lib/scala-compiler-2.8.1.jar"/>
            <pathelement location="lib/scala-library-2.8.1.jar"/>
            <pathelement location="lib/guava.jar"/>
        </classpath>
        <batchtest fork="yes"
                   todir="${build.dir}/${junit.out.dir}">
          <fileset dir="${test.dir}">
            <include name="${unit.test.pat}"/>
            <exclude name="**/AllTests.java"/>
          </fileset>
        </batchtest>
        <syspropertyset>
            <propertyref name="dbtune.custom.loader"/>
            <propertyref name="version"/>
            <propertyref name="build.dir"/>
            <propertyref name="lib.dir"/>
        </syspropertyset>
    </junit>
  </target>
  -->
</project>
